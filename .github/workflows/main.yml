# NOTE: after Mars outposts publishes external crate, this workflow should revert to:
# https://github.com/mars-protocol/rover/blob/8824233d4106eb71ee41a9c7a84b4b94a2bad072/.github/workflows/main.yml
# Rust optimizer does not support local package dependencies from other workspaces. For this reason it is
# temporarily disabled until it can be replaced by a crates.io dep.

on: pull_request

name: Main

jobs:

  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          path: rover

      - name: Checkout mars-outposts
        uses: actions/checkout@v3
        with:
          repository: mars-protocol/outposts
          token: ${{ secrets.TEMP_ACCESS_TOKEN }}
          path: outposts

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: wasm32-unknown-unknown

      - name: Install cargo make
        uses: davidB/rust-cargo-make@v1

      - name: Run cargo check
        working-directory: rover
        run: cargo make check

      - name: Compile WASM contract
        working-directory: rover
        run: cargo make build

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          path: rover

      - name: Checkout mars-outposts
        uses: actions/checkout@v3
        with:
          repository: mars-protocol/outposts
          token: ${{ secrets.TEMP_ACCESS_TOKEN }}
          path: outposts

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install cargo make
        uses: davidB/rust-cargo-make@v1

      - name: Run tests
        working-directory: rover
        run: cargo make test
        env:
          RUST_BACKTRACE: 1

  lints:
    name: Lints
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          path: rover

      - name: Checkout mars-outposts
        uses: actions/checkout@v3
        with:
          repository: mars-protocol/outposts
          token: ${{ secrets.TEMP_ACCESS_TOKEN }}
          path: outposts

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: rustfmt, clippy
          override: true

      - name: Install cargo make
        uses: davidB/rust-cargo-make@v1

      - name: Run formatter
        working-directory: rover
        run: cargo make fmt

      - name: Run cargo clippy
        working-directory: rover
        run: cargo make clippy
